const worldStandard = [
  2.22, 
  2.49, 
  2.35, 
  2.11, 
  2.22, 
  1.95, 
  1.89, 
  1.69, 
  1.98, 
  1.79, 
  1.88, 
  1.96, 
  1.72, 
  2.06, 
  1.90, 
  1.79, 
  1.57, 
  1.64, 
  1.80, 
  2.12, 
  2.06, 
  2.27, 
  2.72, 
  2.50, 
  2.24, 
  2.65, 
  2.78, 
  3.05, 
  3.42, 
  2.94, 
  2.97, 
  3.29, 
  3.73, 
  3.49, 
  3.81, 
  4.12, 
  3.56, 
  3.26, 
  3.34, 
  3.35, 
  4.01, 
  3.83, 
  3.68, 
  3.70, 
  3.50, 
  3.35, 
  4.07, 
  4.77, 
  4.75, 
  5.39, 
  6.11, 
  7.01, 
  8.02, 
  7.65, 
  7.50, 
  6.62, 
  7.14, 
  6.79, 
  7.46, 
  8.61, 
  10.11, 
  11.83, 
  10.83, 
  11.36, 
  11.17, 
  10.95, 
  13.07, 
  11.44, 
  10.86, 
  13.01, 
  13.50, 
  12.25, 
  12.10, 
  13.75, 
  13.44, 
  11.67, 
  10.26, 
  11.77, 
  12.77, 
  13.34, 
  12.36, 
  11.34, 
  9.96, 
  8.86, 
  7.80, 
  7.87, 
  8.20, 
  9.74, 
  8.57, 
  10.37, 
  10.97, 
  10.66, 
  11.07, 
  11.62, 
  13.51, 
  13.96, 
  13.98, 
  13.33, 
  13.27, 
  14.81, 
  16.30, 
  19.15, 
  16.80, 
  17.07, 
  16.26, 
  19.48, 
  22.16, 
  21.74, 
  24.56, 
  22.37, 
  19.71, 
  20.76, 
  18.14, 
  15.61, 
  18.87, 
  17.45, 
  16.00, 
  17.78, 
  15.56, 
  16.96, 
  16.11, 
  17.76, 
  18.09, 
  16.87, 
  17.73, 
  19.09, 
  20.34, 
  18.28, 
  20.59, 
  23.14, 
  27.13, 
  25.23, 
  22.20, 
  19.25, 
  17.64, 
  19.48, 
  21.76, 
  24.89, 
  26.71, 
  31.02, 
  28.67, 
  26.11, 
  30.64, 
  33.68, 
  29.93, 
  32.59, 
  31.18, 
  32.93, 
  34.51, 
  33.87, 
  40.14, 
  40.95, 
  40.33, 
  36.56, 
  38.22, 
  35.10, 
  31.97, 
  29.67, 
  28.76, 
  28.11, 
  26.68, 
  27.36, 
  29.95, 
  28.26, 
  33.45, 
  35.39, 
  41.25, 
  37.81, 
  35.95, 
  38.96, 
  42.18, 
  39.59, 
  34.07, 
  34.79, 
  35.09, 
  33.24, 
  33.58, 
  36.24, 
  31.56, 
  35.04, 
  33.74, 
  39.84, 
  36.54, 
  38.31, 
  39.52, 
  40.97, 
  47.55, 
  54.34, 
  59.73, 
  60.55, 
  68.69, 
  68.40, 
  65.82, 
  58.96, 
  54.32, 
  50.08, 
  46.16, 
  40.33, 
  35.61, 
  41.91, 
  48.07, 
  52.24, 
  61.74, 
  69.43, 
  62.05, 
  64.43, 
  60.89, 
  52.79, 
  60.81, 
  71.97, 
  72.15, 
  63.09, 
  54.96, 
  49.40, 
  47.01, 
  42.94, 
  40.54, 
  39.01, 
  43.50, 
  39.52, 
  39.03, 
  38.35, 
  38.47, 
  41.08, 
  45.62, 
  46.05, 
  55.81, 
  53.40, 
  51.26, 
  51.60, 
  53.62, 
  47.56, 
  43.06, 
  50.75, 
  50.21, 
  46.92, 
  51.62, 
  50.16, 
  54.41, 
  57.22, 
  53.26, 
  51.55, 
  52.23, 
  44.90, 
  42.83, 
  38.99, 
  42.65, 
  40.99, 
  40.88, 
  44.89, 
  41.13, 
  38.59, 
  37.81, 
  42.14, 
  38.27, 
  39.82, 
  40.48, 
  42.22, 
  48.39, 
  48.81, 
  47.97, 
  57.73, 
  64.05, 
  55.86, 
  54.95, 
  59.99, 
  56.19, 
  58.20, 
  55.32, 
  50.36, 
  50.92, 
  60.44, 
  58.13, 
  55.75, 
  60.24, 
  53.27, 
  59.37, 
  63.24, 
  67.09, 
  67.23, 
  75.49, 
  82.30, 
  74.06, 
  73.90, 
  65.56, 
  69.25, 
  61.75, 
  71.99, 
  62.25, 
  72.59, 
  64.56, 
  75.96, 
  87.83, 
  76.71, 
  65.76, 
  56.48, 
  51.44, 
  62.11, 
  74.15, 
  76.57, 
  67.78, 
  79.67, 
  92.20, 
  81.37, 
  81.24, 
  83.13, 
  75.35, 
  64.54, 
  65.66, 
  56.91, 
  60.70, 
  63.70, 
  73.23, 
  88.66, 
  105.14, 
  91.98, 
  101.23, 
  106.44, 
  97.31, 
  91.23, 
  87.17, 
  104.64, 
  95.73, 
  110.49, 
  101.06, 
  100.65, 
  101.89, 
  92.10, 
  98.17, 
  95.07, 
  100.45, 
  118.80, 
  103.32, 
  120.62, 
  108.35, 
  100.84, 
  117.77, 
  127.68, 
  113.43, 
  118.73, 
  135.78, 
  117.17, 
  114.22, 
  102.56, 
  93.40, 
  97.53, 
  114.02, 
  113.28, 
  115.18, 
  117.82, 
  108.92, 
  113.65, 
  105.68, 
  99.24, 
  97.33, 
  115.23, 
  112.57, 
  103.44, 
  95.39, 
  94.23, 
  85.11, 
  82.51, 
  83.74, 
  75.19, 
  77.18, 
  89.74, 
  83.53, 
  92.95, 
  107.81, 
  99.99, 
  95.16, 
  104.87, 
  103.45, 
  101.54, 
  100.00, 
  105.65, 
  106.37, 
  112.65, 
  119.47, 
  116.75, 
  123.56, 
  118.68, 
  120.03, 
  117.87, 
  125.62, 
  134.81, 
  146.36, 
  141.35, 
  144.01, 
  154.88, 
  155.75, 
  149.14, 
  149.14, 
  149.92, 
  161.31, 
  153.86, 
  157.48, 
  144.01, 
  135.67, 
  139.60, 
  129.23, 
  125.58, 
  134.45, 
  138.80, 
  134.59, 
  128.48, 
  117.80, 
  107.13, 
  110.39, 
  117.60, 
  118.98, 
  119.32, 
  117.71, 
  121.85, 
  113.96, 
  110.10, 
  97.82, 
  90.22, 
  90.35, 
  79.79, 
  85.49, 
  89.68, 
  80.88, 
  76.65, 
  75.01, 
  73.85, 
  78.60, 
  78.83, 
  82.13, 
  85.48, 
  89.52, 
  84.90, 
  90.09, 
  88.69, 
  89.57, 
  92.40, 
  93.93, 
  94.34, 
  94.73, 
  93.84, 
  96.12, 
  93.97, 
  93.50, 
  93.22, 
  93.24, 
  93.93, 
  95.35, 
  97.19, 
  98.47, 
  98.61, 
  97.12, 
  103.34, 
  106.31, 
  109.66, 
  109.12, 
  114.20, 
  112.17, 
  117.75, 
  120.30, 
  122.07, 
  124.15, 
  125.00, 
  123.73, 
  117.20, 
  117.70, 
  118.66, 
  121.37, 
  124.11, 
  127.70, 
  125.97, 
  129.20, 
  132.66, 
  129.82, 
  131.18, 
  133.60, 
  139.29, 
  137.71, 
  132.86, 
  133.31, 
  133.86, 
  135.62, 
  128.21, 
  127.06, 
  115.88, 
  112.36, 
  106.62, 
  114.22, 
  116.17, 
  105.45, 
  103.88, 
  108.54, 
  100.23, 
  89.98, 
  84.10, 
  79.23, 
  78.41, 
  71.02, 
  73.06, 
  81.42, 
  83.13, 
  83.51, 
  89.61, 
  92.19, 
  94.11, 
  91.58, 
  93.67, 
  99.78, 
  98.74, 
  101.99, 
  109.23, 
  111.17, 
  108.93, 
  105.38, 
  107.11, 
  105.70, 
  107.57, 
  109.60, 
  114.50, 
  119.27, 
  119.34, 
  122.61, 
  118.16, 
  117.82, 
  119.07, 
  116.20, 
  115.11, 
  106.79, 
  104.70, 
  111.13, 
  112.34, 
  116.43, 
  121.25, 
  124.45, 
  126.62, 
  125.95, 
  123.19, 
  126.14, 
  131.65, 
  131.89, 
  132.77, 
  130.93, 
  132.11, 
  132.78, 
  135.54, 
  140.96, 
  146.87, 
  147.55, 
  150.16, 
  146.03, 
  150.47, 
  148.30, 
  151.69, 
  156.95, 
  159.50, 
  160.93, 
  158.35, 
  162.35, 
  162.93, 
  163.62, 
  169.52, 
  171.98, 
  173.17, 
  179.78, 
  182.37, 
  185.07, 
  189.72, 
  192.31, 
  202.48, 
  215.64, 
  221.69, 
  217.46, 
  223.03, 
  214.35, 
  220.04, 
  202.61, 
  195.88, 
  213.62, 
  222.32, 
  212.35, 
  200.43, 
  198.12, 
  201.72, 
  203.88, 
  210.93, 
  209.00, 
  216.41, 
  217.46, 
  216.66, 
  217.82, 
  228.33, 
  235.13, 
  235.02, 
  245.66, 
  246.66, 
  245.85, 
  243.12, 
  240.62, 
  238.34, 
  236.69, 
  243.38, 
  251.65, 
  251.19, 
  252.80, 
  256.54, 
  251.18, 
  243.66, 
  250.88, 
  261.30, 
  261.12, 
  268.70, 
  273.55, 
  275.55, 
  261.73, 
  264.89, 
  242.41, 
  260.29, 
  270.18, 
  277.59, 
  287.99, 
  272.92, 
  284.66, 
  292.59, 
  289.77, 
  298.94, 
  299.55, 
  311.54, 
  315.18, 
  317.31, 
  293.06, 
  254.56, 
  282.87, 
  291.99, 
  296.83, 
  295.42, 
  311.61, 
  306.84, 
  299.42, 
  328.85, 
  335.13, 
  334.17, 
  343.04, 
  366.06, 
  374.03, 
  373.57, 
  390.89, 
  397.92, 
  409.67, 
  399.95, 
  423.22, 
  425.59, 
  439.25, 
  422.02, 
  410.54, 
  425.81, 
  411.79, 
  405.83, 
  379.82, 
  420.35, 
  408.43, 
  380.25, 
  403.97, 
  414.73, 
  383.13, 
  403.14, 
  402.92, 
  405.45, 
  406.00, 
  416.24, 
  431.34, 
  441.16, 
  437.44, 
  429.09, 
  417.33, 
  442.19, 
  458.21 // 29/12/2023
]

const yearlyRates = [
  1,
  0.9786,
  0.9586,
  0.9386,
  0.9171,
  0.8967,
  0.8757,
  0.8548,
  0.8340,
  0.8126,
  0.7917,
  0.7708,
  0.7496,
  0.7303,
  0.7104,
  0.6931,
  0.6758,
  0.6606,
  0.6463,
  0.6334,
  0.6211,
  0.6093,
  0.5986,
  0.5887,
  0.5794,
  0.5711,
  0.5628,
  0.5550,
  0.5477,
  0.5408,
  0.5346,
]

const getRiskyAssetsRatesPerMonth = (duration) => {
  return worldStandard.slice(-duration);
}


const getNonRiskyAssetsRatesPerMonth = (duration) => {
  const nonRiskyAssetsRatesPerMonth = yearlyRates.reduce(
    (acc, rate, index) => {
      const monthlyRate = (rate - yearlyRates[index + 1]) / 12;
      return [...acc, ...Array(12).fill(rate).map((item, i) => item - (i * monthlyRate))];
    },
    []
  ).slice(0, duration).reverse();


  return nonRiskyAssetsRatesPerMonth;
}

let taxGainChart;

const generateTaxGainChart = (age, retirementAge, paymentsDuration, payment, frequency, tmi, tis) => {
  const effectivePayments = calculateEffectivePayments(age, retirementAge, paymentsDuration, payment, frequency, tmi, tis);
  const labels = effectivePayments.map((payment, index) => `Année ${index + 1}`);
  const effectivePaymentData = effectivePayments.map(payment => payment.effectivePayment);
  const taxGainData = effectivePayments.map(payment => payment.taxGain);

  const ctx = document.getElementById("tax-gain-chart").getContext("2d");

  if (taxGainChart) {
    taxGainChart.destroy();
  }

  taxGainChart = new Chart(ctx, {
    plugins: [ChartDataLabels],
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Versement Effectif",
          data: effectivePaymentData,
          backgroundColor: "rgb(56, 69, 144)",
          barThickness: 15,
        },
        {
          label: "Gain Fiscal",
          data: taxGainData,
          backgroundColor: "rgb(20, 20, 74)",
          barThickness: 15,  
        }
      ],
    },
    options: {
      layout: {
        padding: {
          right: 20
        }
      },
      scales: {
        x: {
          stacked: true,
          grid: {
            display: false
          }
        },
        y: {
          stacked: true,
          ticks: {
            stepSize: 50000,
            callback: function (value, index, values) {
              return `${value} €`;
            }
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        datalabels: {
          font: {
            size: 8,
            weight: "bold"
          },
          backgroundColor: "white",
          borderRadius: 4,
          borderColor: "rgb(20, 20, 74)",
          borderWidth: 1,
          color: "rgb(20, 20, 74)",
          padding: 2,
          formatter: function(value, context) {
              return `${Math.ceil(value)} €`;
          },
          display: (context) => {
            return context.dataIndex === context.dataset.data.length - 1;
          },
        },
      },
    }
  });
}


let performanceChart;

const generatePerformanceChart = (age, retirementAge, paymentsDuration, payment, frequency, tmi, tis, profile) => {
  const effectivePayments = calculateEffectivePayments(age, retirementAge, paymentsDuration, payment, frequency, tmi, tis);
  const effectivePaymentsTotal = effectivePayments.reverse()[0];
  const investerProfile = profiles[profile];
  const investedAmount = effectivePaymentsTotal.effectivePayment + effectivePaymentsTotal.taxGain;
  const investmentDuration = getInvestmentDuration(age, retirementAge) * 12;
  const paymentsDurationMonths = paymentsDuration * 12;

  // Calculate risky assets performance
  const riskyAssetsRatesPerMonth = getRiskyAssetsRatesPerMonth(investmentDuration)
  const riskyAssetsPayment = payment * investerProfile.risky
  const riskyAssets = calculateStocksValue(riskyAssetsPayment, investmentDuration, paymentsDurationMonths, riskyAssetsRatesPerMonth, frequency)
  const riskyAssetsPerformance = calculateStocksPerformance(riskyAssets.total, investerProfile.risky, investedAmount);

  // Calculate non risky assets performance
  const nonRiskyAssetsRatesPerMonth = getNonRiskyAssetsRatesPerMonth(investmentDuration) 
  const nonRiskyAssetsPayment = payment * investerProfile.nonRisky
  const nonRiskyAssets = calculateStocksValue(nonRiskyAssetsPayment, investmentDuration, paymentsDurationMonths, nonRiskyAssetsRatesPerMonth, frequency)
  const nonRiskyAssetsPerformance = calculateStocksPerformance(nonRiskyAssets.total, investerProfile.nonRisky, investedAmount);

  const fee = riskyAssets.fee + nonRiskyAssets.fee
  const total = investedAmount + nonRiskyAssetsPerformance + riskyAssetsPerformance - fee; 
  
  const gainRatio = calculateGainRatio(total, effectivePaymentsTotal.effectivePayment)
  const performance = ((gainRatio - 1) * 100);

  document.getElementById("guaranteed_perf").innerText = `+ ${performance.toFixed(2)} %`;
  document.getElementById("guaranteed_multiple").innerText = `${gainRatio}`;

  const labels = ["Versements", "Performance", "Total"]
  const ctx = document.getElementById("performance-chart").getContext("2d");

  if (performanceChart) {
    performanceChart.destroy();
  }

  const triangleBackgroundPlugin = {
    id: 'triangleBackground',
    beforeDraw: (chart, args, options) => {
      const { ctx } = chart;
      ctx.save();
      ctx.globalCompositeOperation = 'destination-over';
      ctx.fillStyle = options.color || '#99ffff';
  
      // Clear the previous rectangle
      ctx.clearRect(65, -30, chart.width, chart.height);
  
      ctx.beginPath();
      const xAxis = chart.scales.x;
      const yAxis = chart.scales.y;
      ctx.moveTo(xAxis.left, yAxis.bottom);
      ctx.lineTo(xAxis.right, yAxis.bottom);
      ctx.lineTo(xAxis.right, yAxis.top);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
  }}

  performanceChart = new Chart(ctx, {
    plugins: [ChartDataLabels, triangleBackgroundPlugin],
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Versement Effectif",
          data: [effectivePaymentsTotal.effectivePayment, 0, 0],
          backgroundColor: "rgb(56, 69, 144)",
          barThickness: 50,
        },
        {
          label: "Gain Fiscal",
          data: [effectivePaymentsTotal.taxGain, 0, 0],
          backgroundColor: "rgb(20, 20, 74)",
          barThickness: 50,
        },
        {
          label: "Intérêts Garantis",
          data: [0, nonRiskyAssetsPerformance, 0],
          backgroundColor: "rgb(20, 20, 70)",
          barThickness: 50
        },
        {
          label: "Performance Actions",
          data: [0, riskyAssetsPerformance, 0],
          backgroundColor: "rgb(130, 139, 188)",
          barThickness: 50
        },
        {
          label: "Total Frais Inclus",
          data: [0, 0, total],
          backgroundColor: "rgb(28, 175, 102)",
          barThickness: 50
        }
      ]
    },
    options: {
      scales: {
        x: {
          stacked: true,
          grid: {
            display: false
          }
        },
        y: {
          stacked: true,
          grid: {
            display: false
          },
          ticks: {
            stepSize: 100000,
            callback: function (value, index, values) {
              return `${value} €`;
            }
          }
        }
      },
      plugins: {
        triangleBackground: {
          color: "rgb(241, 242, 255)"
        },
        legend: {
          display: false,
        },
        datalabels: {
            font: {
              size: 8,
              weight: "bold"
            },
            color: "white",
            formatter: function(value, context) {
                return `${Math.ceil(value)} €`;
            },
            display: function(context) {
              return context.dataset.data[context.dataIndex] > 0;
            },
        },
        tooltip: {
          filter: function (tooltipItem, data) {
            return !!tooltipItem.raw
          },
        },
      }
    },
  });
}

const profiles = { safe: { nonRisky: 1, risky: 0 }, careful: { nonRisky: .7, risky: .3 }, balanced: { nonRisky: .5, risky: .5 } };

const getInvestmentDuration = (age, retirementAge) => Math.min(retirementAge - age, 30);

const calculateTaxGainRate = (tmi, tis) => (100 - tmi + tis) / 100;

const calculateEffectivePayments = (age, retirementAge, paymentsDuration, paymentAmount, frequency, tmi, tis) => {
  const getYearlyPayment = (payment, frequency) => {
    switch (frequency) {
      case "monthly":
        return payment * 12
      case "quarterly":
        return payment * 4
      case "yearly":
        return payment
      default:
        return payment
    }
  }

  const investmentDuration = getInvestmentDuration(age, retirementAge);
  const taxGainRate = calculateTaxGainRate(tmi, tis);
  const effectivePayments = [];

  const yearlyPaymentAmount = getYearlyPayment(paymentAmount, frequency)

  for (let i = 0; i < investmentDuration; i++) {
    const year = i + 1;
    if (year > paymentsDuration) break;
    const payment = yearlyPaymentAmount * year;
    const effectivePayment = payment * taxGainRate;
    const taxGain = payment - effectivePayment;
    const yearlyPayment = { effectivePayment, taxGain };
    effectivePayments.push(yearlyPayment);
  }
  return effectivePayments;
};

const calculateStocksValue = (payment, investmentDuration, paymentsDuration, rates, frequency) => {
  const isPaymentDate = (month, frequency) => {
    switch (frequency) {
      case "monthly":
        return month % 1 === 0
      case "quarterly":
        return month % 3 === 0
      case "yearly":
        return month % 12 === 0
      default:
        return false
    }
  }

  const calculateFeeRate = (frequency) => {
    const fee = 0.012
    switch (frequency) {
      case "monthly":
        return 1 - (fee / 12);
      case "quarterly":
        return 1 - (fee / 4);
      case "yearly":
        return 1 - fee;
      default:
        return 1 - fee;
    }
  }

  let totalStocksValue = 0;

  const feeRate = calculateFeeRate(frequency);
  let totalStocksValueWithFees = 0;


  for (let i = 0; i < investmentDuration; i++) {
    if (!isPaymentDate(i, frequency)) {
      continue
    }
    if (i < paymentsDuration) {
      const currentRate = rates[i];
      const currentValue = payment / currentRate;
      totalStocksValue += currentValue;
      totalStocksValueWithFees = (totalStocksValueWithFees + currentValue) * feeRate;
    } else {
      totalStocksValueWithFees = totalStocksValueWithFees * feeRate;
    }
  }

  const lastRate = rates[investmentDuration - 1];

  const total = totalStocksValue * lastRate;
  const totalWithFee = totalStocksValueWithFees * lastRate;

  const fee = total - totalWithFee;

  return { total, fee }
};

const calculateStocksPerformance = (value, ratio, investedAmount) => Math.ceil(value - (ratio * investedAmount));

const calculateGainRatio = (total, effectivePayment) => (total / effectivePayment).toFixed(2);

const getCheckedValue = name => {
  const elements = document.getElementsByName(name);
  const checkedElement = Array.from(elements).find(element => element.checked);
  return checkedElement ? checkedElement.value : null;
};

const getValueById = id => {
  const element = document.getElementById(id);
  return element ? element.value : null;
};

const handleSimulateTaxGain = () => {
  const age = parseInt(getValueById("age"));
  const retirementAge = parseInt(getValueById("retirement-age"));
  const tmi = parseInt(getValueById("tmi"));
  const tis = parseInt(getValueById("tis"));
  const paymentsDuration = Math.min(parseInt(getValueById("payments-duration")), 30);
  const payment = parseInt(getValueById("payment-amount"));
  const frequency = getCheckedValue("frequency");

  generateTaxGainChart(age, retirementAge, paymentsDuration, payment, frequency, tmi, tis);
};

const handleSimulatePerformance = () => {
  const age = parseInt(getValueById("age"));
  const retirementAge = parseInt(getValueById("retirement-age"));
  const tmi = parseInt(getValueById("tmi"));
  const tis = parseInt(getValueById("tis"));
  const paymentsDuration = Math.min(parseInt(getValueById("payments-duration")), 30);
  const frequency = getCheckedValue("frequency");
  const payment = parseInt(getValueById("payment-amount"));
  const profile = getCheckedValue("profile");

  generatePerformanceChart(age, retirementAge, paymentsDuration, payment, frequency, tmi, tis, profile);
};

const displayCharts = () => {
  handleSimulateTaxGain();
  handleSimulatePerformance();
}

const setDurationInputListener = (name) => {
  const input = document.getElementById(name);
  const defaultValue = input.value;
  document.getElementById(`${name}-display`).innerText = `${defaultValue} ans`;

  input.addEventListener('input', function () {
    const value = this.value;
    document.getElementById(`${name}-display`).innerText = `${value} ans`;
  });
};

const setRadioLabelListeners = () => {
  const labels = document.querySelectorAll('label');

  labels.forEach(label => {
    const parent = label.parentElement;
    label.addEventListener('click', () => {
      const siblingLabels = parent.querySelectorAll('label');
      siblingLabels.forEach(lbl => {
        lbl.classList.remove('selected');
      });
      label.classList.add('selected');
    });
  });
};

const setDisplayButtonListeners = () => {
  const ageField = document.getElementById('age');
  const retirementAgeField = document.getElementById('retirement-age');
  const paymentAmountField = document.getElementById('payment-amount');
  const tmiField = document.getElementById('tmi');
  const tisField = document.getElementById('tis');
  const paymentsDurationField = document.getElementById('payments-duration');
  const profileRadioButtons = document.querySelectorAll('input[name="profile"]');
  const frequencyRadioButtons = document.querySelectorAll('input[name="frequency"]');

  const checkFields = () => {
    let allFieldsFilled = true;

    [ageField, retirementAgeField, paymentAmountField, tmiField, tisField, paymentsDurationField].forEach(field => {
      if (!field.value.trim()) {
        allFieldsFilled = false;
      }
    })

    let profileRadioButtonChecked = false;
    profileRadioButtons.forEach(button => {
      if (button.checked) {
        profileRadioButtonChecked = true;
      }
    });
    
    let frequencyRadioButtonsChecked = false;
    frequencyRadioButtons.forEach(button => {
      if (button.checked) {
        frequencyRadioButtonsChecked = true;
      }
    });

    if (allFieldsFilled && profileRadioButtonChecked && frequencyRadioButtonsChecked) {
      document.getElementById("simulate-button").style.display = "block";
    } else {
      document.getElementById("simulate-button").style.display = "none";
    }
  }

  checkFields();

  [ageField, retirementAgeField, paymentAmountField, tmiField, tisField, paymentsDurationField].forEach(field => {
    field.addEventListener('input', checkFields);
  });

  profileRadioButtons.forEach(button => {
    button.addEventListener('change', checkFields);
  });
  
  frequencyRadioButtons.forEach(button => {
    button.addEventListener('change', checkFields);
  });
}

const setMaxDurationListeners = () => {
  const ageInput = document.getElementById('age');
  const retirementAgeInput = document.getElementById('retirement-age');
  const durationInput = document.getElementById('payments-duration');
  const durationDisplay = document.getElementById('payments-duration-display');

  ageInput.addEventListener('input', updateMaxAndValue);
  retirementAgeInput.addEventListener('input', updateMaxAndValue);
  

  function updateMaxAndValue() {
    const age = parseInt(ageInput.value);
    const retirementAge = parseInt(retirementAgeInput.value);
    const maxDuration = Math.min(Math.max(retirementAge - age, 0), 30);    
    durationInput.max = maxDuration;

    if (durationInput.value > maxDuration || parseInt(durationInput.value) === 0) {
      durationInput.value = maxDuration
    }
    
    durationDisplay.innerText = `${durationInput.value} ans`;
  }

  retirementAgeInput.min = ageInput.value;
}

const preventNumberInputFromChangingOnMouseWheel = () => {
  const numberInputs = document.querySelectorAll('input[type="number"]');
  
  numberInputs.forEach(function(input) {
      input.addEventListener('mousewheel', function(event) {
          event.preventDefault();
      }, { passive: false });
  });
}

document.addEventListener('DOMContentLoaded', function () {
  preventNumberInputFromChangingOnMouseWheel()
  document.getElementById("tmi").value = 30;
  document.getElementById("tis").value = 15;

  // Hide simulate button until all inputs are filled
  document.getElementById("simulate-button").style.display = "none";
  
  document.getElementById("simulate-button").addEventListener("click", displayCharts);
  setDurationInputListener("age");
  setDurationInputListener("payments-duration");
  setRadioLabelListeners();
  setDisplayButtonListeners();
  setMaxDurationListeners();
}); 